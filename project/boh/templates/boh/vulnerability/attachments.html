{% extends "boh/vulnerability/base_vulnerability.html" %}

{% load i18n %}
{% load boh_tags %}
{% load humanize %}
{% load markdown_render %}

{% block title %}{{ vulnerability.name }}{% endblock %}

{% block vulnerability_content %}
  <div class="row">
    <div class="col-md-12 clearfix">
      <div class="pull-right">
        <nav>
          <span class="text-muted"><b>{{ attachments.start_index }}</b> - <b>{{ attachments.end_index }}</b> of <b>{{ attachments.paginator.count }}</b></span>
          <div class="btn-group" role="group" aria-label="...">
            <a class="btn btn-default{% if not attachments.has_previous %} disabled{% endif %}" href="{% if attachments.has_previous %}?page={{ attachments.previous_page_number }}{% endif %}" role="button"><span class="fa fa-chevron-left"></span></a>
            <a class="btn btn-default{% if not attachments.has_next %} disabled{% endif %}" href="{% if attachments.has_next %}?page={{ attachments.next_page_number }}{% endif %}" role="button"><span class="fa fa-chevron-right"></span></a>
          </div>
        </nav>
      </div>
      <a href="{% url 'boh:vulnerability.attachments.add' vulnerability_id=vulnerability.id %}" class="btn btn-success" role="button"><i class="fa fa-plus"></i> {% trans 'Attach a file' %}</a>
    </div>
  </div>

  <hr />

  <div class="row">
    <div class="col-md-12">
      <div class="table-responsive">
        <form method="post" id="delete_form" action="{% url 'boh:vulnerability.attachments.delete' vulnerability_id='00'  attachment_id='000' %}">
        {% csrf_token %}
        <table class="table table-striped">
          <thead>
          <tr>
            <th class="col-md-4">{% trans 'File name' %}</th>
            <th class="col-md-7">{% trans 'Description' %}</th>
            <th class="col-md-1">{% trans 'Delete' %}</th>
          </tr>
          </thead>
          <tbody>
          {% for item in attachments %}
            <tr>
              <td><a href="{{ item.attachment.url }}" target="_blank" rel="noopener noreferrer">{{ item.file_name }} </a></td>
              <td> {{ item.description|markdown_render }}</td>
              <td><a href="#" onclick="javascript:delete_attachment({{ item.id }}, '{{ item.file_name }}');" class="btn btn-danger" role="button"><i class="fa fa-remove"></i> {% trans 'Delete' %}</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        </form>
      </div>
    </div>
  </div>
{% endblock vulnerability_content %}
{% block js %}
  <script>

    function delete_attachment(attachment_id, file_name) {
      var warning_msg = "{% trans 'Are you sure you want to delete \"file_name\" ?' %}";
      warning_msg = warning_msg.replace('file_name', file_name);
      var response = confirm(warning_msg);
      if (response) {
          var vulnerability_id = {{ vulnerability.id }};
          var delete_form = $('#delete_form');
          if (delete_form) {
            var action_url = delete_form.attr("action");
            action_url = action_url.replace('00', vulnerability_id).replace('000', attachment_id);
            delete_form.attr('action', action_url).submit();
          }
      }
    }
  </script>
{% endblock js %}
